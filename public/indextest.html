<html>
<head>
<script src="http://localhost:3000/socket.io/socket.io.js"></script>
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script> <!-- upgrade to latest for production -->
<script type="text/javascript" charset="utf-8">

var serverPacket;

	function parseText(string) {
		if (string.indexOf('/') != -1) {
			
		} else if (string.indexOf('*') != -1 &&  string.indexOf('*')+1 != '/' ) {
			console.log("parsing");
			var startAt = string.indexOf('*');
			console.log(startAt);
			var endAt = string.indexOf('*', startAt+1);
			console.log(endAt);
			string = string.split("");
			string.splice(endAt, 1, '</b>');
			string.splice(startAt, 1, '<b>');
			string = string.join("");
		}
		return string;
	}

$(document).ready(function () {


	var log_chat_message = function  (message, type, color) {
		
		message = parseText(message);
		
		var li = $('<li />').html(message);
		
		
		if (type === 'system') {
			li.css({'font-weight': 'bold'});
		} else if (type === 'leave' || type === 'error') {
			li.css({'font-weight': 'bold', 'color': '#F00'});
		}
		else if (type === 'command') {
			li.css({'font-weight': 'bold', 'font-style': 'italic'});
		} 
		else {
			li.css({'color': color});
		}
		$('#chat_log').append(li);
		
		
	};

	var socket = io.connect('http://localhost:3000/');

//Received
	
	socket.on('entrance', function  (data) {
		log_chat_message(data.message, 'system');
	});

	socket.on('system', function  (data) {
		log_chat_message(data.message, 'system');
	});
	
	socket.on('exit', function  (data) {
		log_chat_message(data.message, 'leave');
	});

	socket.on('chat', function  (data) {
		log_chat_message(data.message, 'normal', data.color);
	});

	socket.on('error', function  (data) {
		log_chat_message(data.message, 'error');
	});

	
	$('#chat_box').keypress(function (event) {
		if (event.which == 13) {
		
		var userInput = $('#chat_box').val();
		if (userInput.charAt(0) === "/") {
			command_handler(userInput); //Route the input to separate function
		} else {
			socket.emit('chat', {message:userInput});
			$('#chat_box').val('');
			}
			
		$('#chat_box').val('');
		} //Close 
	});


	function command_handler(input) {
		if (input.indexOf('help') != -1) {
			help();
		}
	else if(input.indexOf('name') != -1) {
			var username = input.split(" ")[1];
				socket.emit('register', {message:username});
		}
	else if(input.indexOf('color') != -1) {
			var color = input.split(" ")[1];
				socket.emit('color', {message:color});
		}
		
		else 
			log_chat_message( "Invalid command. Type in /help for a list of commands. ", "command" );
	}

	function help() {
		log_chat_message("You asked for help?", "system"); 
		log_chat_message("/help for help", "system"); 
		log_chat_message("/name yourname to change your display name", "system"); 
		log_chat_message("/color css_color_value to change your display color. Other users will see this.", "system"); 
		log_chat_message(" Thank you. ", "system"); 
	}

});
</script>
<style type="text/css">
	div#chatroom {
		display: block;
		height: 300px;
		border: 1px solid #999;/*
		overflow: auto;*/
		width: 100%;
		margin-bottom: 10px;
		position: relative;
	}

	ul#chat_log {
		list-style: none;
		position: absolute;
		width:95%;
		bottom: 0px;
	}

	input#chat_box {
		width: 99%;
	}
</style>
</head>
<body>

	<div id="chatroom">
		<ul id="chat_log">
		</ul>
	</div>

	<input type="text" name="chat_box" value="" id="chat_box" placeholder="type to chat..." />
	<br /> Be nice!
</body>
</html>